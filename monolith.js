(function(name, definition) {
    if (typeof module != 'undefined') module.exports = definition();
    else if (typeof define == 'function' && typeof define.amd == 'object') define(definition);
    else this[name] = definition();
}('BAS', function() {
	"use strict";

var LIB={__heap:{uses:["erroom"],code:";heap management 1.1\n\tHP_INIT:\n\n\tLXI     H,((RAMTOP-HEAP)&0xfffe)-4 \n\tSHLD    HEAP \n\tLXI     H,HEAP \n\tCALL    hp_n \n\tMVI     A,0FFh \n\tMOV     m,a \n\tINX     h \n\tMOV     m,a \n\tRET \nHP_F: LXI     H,HEAP+1 \nHP_F2:\n\tMOV     d,m \n\tDCX     h \n\tMOV     e,m \n\tMOV     A,E \n\tANI     01h ;0=empty,1=full\n\tRET     \nHP_N:   \n\tMOV     A,M \n\tANI     0FEh\n\tMOV     E,A \n\tINX     H \n\tMOV     D,M \n\tDCX     H \n\tDAD     D \n\tINX     H \n\tINX     H \n\tINX     H \n\tJMP     HP_F2 \n\nHP_FE:\n\tCALL    hp_f \nHP_FE2: \n\tRZ\n\tMOV     a,d \n\tANA     e \n\tINR     a \n\tJZ      ERROOM \nHP_FEN: \n\tCALL    hp_n \n\tJMP     hp_fe2 \nHP_FREE:\n\tMOV     a,m \n\tANI     0feh \n\tMOV     m,a \n\tRET     \nHP_JOIN:\n\tCALL    hp_fe \nHP_J0:  \n\tPUSH    h \n\tCALL    hp_n \n\tJZ      hp_j \n\tMOV     a,e \n\tANA     d \n\tINR     a \n\tPOP     d \n\tRZ      \n\tCALL    hp_fe2 \n\tJMP     hp_j0 \nHP_J:   \n\tPOP     h \n\tMOV     a,e \n\tADD     m \n\tMOV     e,a \n\tINX     h \n\tMOV     a,d \n\tADC     m \n\tMOV     d,a \n\tINX     d \n\tINX     d \n\tMOV     m,d \n\tDCX     h \n\tMOV     m,e \n\tORI     1 ; Z=0\n\tRET     \nHP_A:\n\tINX     b \n\tMOV     a,c \n\tRRC     \n\tJNC     hp_aeven \n\tINX     b \nHP_AEVEN:           \n\tCALL    hp_fe \nHP_ALOP:\n\tMOV     a,d \n\tCMP     b \n\tJC      hp_alow \n\t;JNZ     hp_amore \n\tMOV     a,e \n\tCMP     c \n\tjz hp_aexact\n\t;porovnat, jestli zbývá alespoň n+6\n\tpush b\n\tinx b\n\tinx b\n\tinx b\n\tinx b\n\tinx b\n\tinx b\n\tmov a,d\n\tcmp b\n\tjc hp_alow6        \n\tjnz hp_amore6\n\tmov a,e\n\tcmp c\n\tjnc hp_amore6\nhp_alow6:\n\tpop b\nHP_ALOW:\n\tCALL    hp_fen \n\tJMP     hp_alop \nhp_amore6:\n\tpop b\nHP_AMORE:           \n\tMOV     a,e \n\tSUB     c \n\tMOV     e,a \n\tMOV     a,d \n\tSBB     b \n\tMOV     d,a \n\tDCX     d \n\tDCX     d \n\tPUSH    h \n\tDAD     b\n\tINX     h \n\tINX     h \n\tMOV     m,e \n\tINX     h \n\tMOV     m,d \n\tPOP     h \nhp_aexact:\n\tINX     b \n\tMOV     m,c \n\tINX     h \n\tMOV     m,b \n\tINX     h\n\tMVI     m,0aah \n\tINX     h\n\tRET     \nhp_test:\n\tpush d\n\tlxi d,HEAP\n\tmov a,h\n\tcmp d\n\tjc hp_noheap\n\tjnz hp_noheap\n\tmov a,l\n\tcmp e\nhp_noheap: \n\tpop d\n\tret        \nhp_unass: \n\tcall hp_test\n\trc\n\tdcx h\n\tMVI     m,0aah \n\tINX     h\n\tret        \nhp_assign: \n\tcall hp_test\n\trc\n\tdcx h\n\tMVI     m,055h \n\tINX     h\n\tret        \nhp_gc:\n\tCALL    hp_f \nHP_gc1: \n\tJZ hp_gcn\nhp_gc2:        \n\tMOV     a,d \n\tANA     e \n\tINR     a \n\tJZ hp_gcf\n\tinx h\n\tinx h\n\tmov a,m\n\tdcx h\n\tdcx h\n\tcpi 0aah ;unassigned\n\tjnz hp_gcn\n\tpush h\n\tcall hp_free\n\tpop h\nHP_gcN: \n\tCALL    hp_n \n\tJMP     hp_gc2 \t\n\t\nHP_gcf:    CALL    hp_join \n\tJNZ     hp_gcf\n\tret        \nHP_DONE:\n"},printstr:{uses:["serout"],code:"\tMOV A,M\n\tORA A\n\tRZ\n\tCALL serout\n\tINX H\n\tJMP printstr\n"},printint:{uses:["s_div10","serout","f_abs"],code:"\tMOV     a,h \n\tORA     a \n\tJP      pipos \n\tMVI     a,2Dh ;- \n\tCALL serout\n\tCALL    f_abs \npipos:\tCALL  s_div10 \n\tPUSH    psw \n\tMOV     a,h \n\tORA     l \n\tJZ      pilast \n\tCALL    pipos \npilast:\tPOP     psw \n\tADI 30h\n\tCALL serout\n\tRET\n"},prtchan:{uses:null,sysdb:["prtchan"],code:"\tMOV A,L\n\tSTA sv_prtchan\n\tRET\n"},println:{uses:["serout"],code:"\tMVI A,0Dh\n\tCALL SEROUT\n\tMVI A,0Ah\n\tCALL SEROUT\n\tRET\n"},printtab:{uses:["serout"],code:"\tMVI A,20h\n\tCALL SEROUT\n\tMVI A,09h\n\tCALL SEROUT\n\tRET\n"},input:{uses:["serin"],code:"    lxi h,i_buffer\n    mvi c,0\ni_rd_l:\n    call serin\n    jz i_rd_l\n    cpi 0dh\n    jz i_eol\n    cpi 0ah\n    jz i_eol\n    mov m,a\n    inx h\n    inr c\n    jnz i_rd_l\ni_eol:\n    mvi m,0\n    ret \n"},inputint:{uses:["input","f_val"],code:"    call input\n    lxi h,i_buffer\n    call f_val\n    ret        \n"},inputstr:{uses:["input","__heap","s_strcpy"],code:"    call input\n    inx b\n    call hp_a\n    lxi d,i_buffer\n    jmp s_strcpy\n"},errovfl:{uses:["printstr"],code:'\tlxi h,errovfl_m\n\tcall printstr\n\tjmp errgo\nerrovfl_m:\n\tdb 0ah,0dh\n\t.cstr "### MULT OVFL",0dh,0ah\n'},erridx:{uses:["printstr"],code:'\tlxi h,erridx_m\n\tcall printstr\n\tjmp errgo\nerridx_m:\n\tdb 0ah,0dh\n\t.cstr "### INDEX OUT OF LIMITS",0dh,0ah\n'},errdiv:{uses:["printstr"],code:'\tlxi h,errdiv_m\n\tcall printstr\n\tjmp errgo\nerrdiv_m:\n\tdb 0ah,0dh\n\t.cstr "### DIVISION BY ZERO",0dh,0ah\n'},erroom:{uses:["printstr"],code:'\tlxi h,erroom_m\n\tcall printstr\n\tjmp errgo\nerroom_m:\n\tdb 0ah,0dh\n\t.cstr "### OUT OF MEMORY",0dh,0ah\n'},errstop:{uses:["printstr"],code:'\tlxi h,errstop_m\n\tcall printstr\n\tjmp errgo\nerrstop_m:\n\tdb 0ah,0dh\n\t.cstr "### STOP",0dh,0ah\n'},errnodata:{uses:["printstr"],code:'\tlxi h,errnodata_m\n\tcall printstr\n\tjmp errgo\nerrnodata_m:\n\tdb 0ah,0dh\n\t.cstr "### NO DATA",0dh,0ah\n'},mul16:{uses:null,code:"    push h\n    pop b\n    lxi h,0\n    mvi a,16\nmul16loop:\n    dad h\n    push psw\n    mov a,e\n    ral\n    mov e,a\n    mov a,d\n    ral\n    mov d,a\n    jnc mul16no\n    dad b\n    jnc mul16no\n    inx d\nmul16no:\n    pop psw\n    dcr a\n    jnz mul16loop\n    ret\n"},div16:{uses:null,code:"    push d\n    push h\n    pop d\n    pop b\n    mvi a,16\n    lxi h,0\n    jmp div16_skip\ndiv16_loop:\n    dad b\ndiv16_lop2:   \n    pop psw\n    dcr a\n    rz\ndiv16_skip:\n    push psw\n    xchg\n    dad h\n    xchg\n    jnc div16_adc\n    dad h\n    inx h\n    jmp div16_adskip\ndiv16_adc:\n    dad h\ndiv16_adskip:    \n    ;sbc hl,bc\n    mov a,l\n    sub c\n    mov l,a\n    mov a,h\n    sbb b\n    mov h,a\n    jc div16_loop\n    inr e\n    jmp div16_lop2        \n"},s_lut:{uses:null,code:"\txchg\n\tlxi b,datatable+2\nlut_l:\n\tldax b\n\tmov l,a\n\tinx b\n\tldax b\n\tmov h,a\n\tora l\n\tjz lut_prev\n\tmov a,h\n\tcmp d\n\tjc lut_prev\n\tmov a,l\n\tcmp e   \n\tjnc lut_next\nlut_prev:\n\tdcx b\n\tdcx b\n\tldax b\n\tmov h,a\n\tdcx b\n\tldax b\n\tmov l,a\n\tora h\n\tret\nlut_next:\n\tinx b\n\tinx b\n\tinx b\n\tjmp lut_l\n"},s_read:{uses:null,code:"\tlhld datapoint\n\tmov e,m\n\tinx h\n\tmov d,m\n\tinx h\n\tshld datapoint\n\txchg\n\tret\n"},s_strcpy:{uses:null,code:"    push h\ns_strcpy2:\n    ldax d\n    mov m,a\n    ora a\n    jz strcpe\n    inx d\n    inx h\n    jmp s_strcpy2\nstrcpe:\n    pop h\n    ret        \n"},s_div10:{uses:null,code:"\tmvi c,10\n\tmvi b,16\n\txra a\ns_d10_1:dad h\n\tral\n\tcmp c\n\tjc s_d10_2\n\tinr l\n\tsub c\ns_d10_2: dcr b\n\tjnz s_d10_1\n\tRET\n"},s_mul10:{uses:null,code:"    push d\n    dad h\n    mov d,h\n    mov e,l\n    dad h\n    dad h\n    dad d\n    pop d\n    ret\n"},s_mul10add:{uses:null,code:"    push d\n    dad h\n    mov d,h\n    mov e,l\n    dad h\n    dad h\n    dad d\n    pop d\n    dad d\n    ret\n"},s_check:{uses:["erridx"],code:"    mov a,h\n    cmp b\n    jc s_c_g\n    mov a,l\n    cmp c\n    jnc erridx\ns_c_g:\n    dad h\n    dad d\n    ret\n"},o_logic:{uses:null,code:"olofix: LXI B,8000h\n\tDAD B\n\tXCHG\n\tDAD B\n\tXCHG\n\tRET\ndofalse: LXI H,0\n\tRET\ndotrue: LXI H,1\n\tRET\n"},o_lt:{uses:["o_logic"],code:"\tCALL olofix\n\tMOV A,H\n\tCMP D\n\tJC dofalse\n\tJNZ dotrue\n\tMOV A,L\n\tCMP E\n\tJZ dofalse\n\tJC dofalse\n\tJMP dotrue\n"},o_ge:{uses:["o_logic"],code:"\tCALL olofix\n\tMOV A,H\n\tCMP D\n\tJC dotrue\n\tJNZ dofalse\n\tMOV A,L\n\tCMP E\n\tJZ dotrue\n\tJC dotrue\n\tJMP dofalse\n"},o_gt:{uses:["o_logic"],code:"\tCALL olofix\n\tMOV A,D\n\tCMP H\n\tJC dofalse\n\tJNZ dotrue\n\tMOV A,E\n\tCMP L\n\tJZ dofalse\n\tJC dofalse\n\tJMP dotrue\n"},o_le:{uses:["o_logic"],code:"\tCALL olofix\n\tMOV A,D\n\tCMP H\n\tJC dotrue\n\tJNZ dofalse\n\tMOV A,E\n\tCMP L\n\tJZ dotrue\n\tJC dotrue\n\tJMP dofalse\n"},o_eq:{uses:["o_logic"],code:"\tMOV A,L\n\tCMP E\n\tJNZ dofalse\n\tMOV A,H\n\tCMP D\n\tJNZ dofalse\n\tJMP dotrue\n"},o_neq:{uses:["o_logic"],code:"\tMOV A,L\n\tCMP E\n\tJNZ dotrue\n\tMOV A,H\n\tCMP D\n\tJNZ dotrue\n\tJMP dofalse\n"},o_streq:{uses:["o_logic"],code:"\tLDAX D\n\tCMP M\n\tJNZ dofalse\n\tORA A\n\tJZ dotrue\n\tINX D\n\tINX H\n\tJMP o_streq\n"},o_add:{uses:null,inline:!0,code:"\tDAD D\t;o_add\n"},o_mul:{uses:["mul16","errovfl","f_abs"],code:"    mov a,h\n    xra d\n    ani 80h\n    jm o_mul_minus\n    call o_mulabs\n    mov a,d\n    ora e\n    jnz errovfl\n    RET\no_mul_minus:\n    call o_mulabs\n    mov a,d\n    ora e\n    jnz errovfl\n    mov a,h\n    cma\n    mov h,a\n    mov a,l\n    cma\n    mov l,a\n    inx h\n    RET\no_mulabs:\n    call f_abs\n    xchg \n    call f_abs\n    jmp mul16\n"},o_sub:{uses:null,inline:!0,code:"\tMOV A, E\n\tSUB L\n\tMOV L, A\n\tMOV A, D\n\tSBB H\n\tMOV H, A\n"},o_div:{uses:["div16","errdiv","f_abs"],code:"    mov a,h\n    ora l\n    jz errdiv\n    mov a,h\n    xra d\n    ani 80h\n    jm o_div_minus\n    call o_divabs\n    xchg\n    RET\no_div_minus:\n    call o_divabs\n    xchg\n    mov a,h\n    cma\n    mov h,a\n    mov a,l\n    cma\n    mov l,a\n    inx h\n    RET\no_divabs:\n    call f_abs\n    xchg \n    call f_abs\n    jmp div16\n"},o_mod:{uses:["div16","errdiv","f_abs"],code:"    mov a,h\n    ora l\n    jz errdiv\n    mov a,h\n    xra d\n    ani 80h\n    jm o_mod_minus\n    call o_modabs\n    RET\no_mod_minus:\n    call o_modabs\n    mov a,h\n    cma\n    mov h,a\n    mov a,l\n    cma\n    mov l,a\n    inx h\n    RET\no_modabs:\n    call f_abs\n    xchg \n    call f_abs\n    jmp div16\n"},o_concat:{uses:["__heap"],code:"        push h\n        push d\n        lxi b,0\n    o_cc_cnt:\n        mov a,m\n        inx h\n        ora a\n        jz o_cc_cnt1\n        inx b\n        jmp o_cc_cnt\n    o_cc_cnt1:\n        ldax d\n        inx d\n        ora a\n        jz o_cc_a\n        inx b\n        jmp o_cc_cnt1\n    o_cc_a:\n        inx b\n        call hp_a\n        push h\n        pop b\n        pop d\n    o_cc_l1:\n        ldax d\n        ora a\n        jz o_cc_l2\n        mov m,a\n        inx d\n        inx h\n        jmp o_cc_l1\n    o_cc_l2:\n        pop d\n    o_cc_l3:\n        ldax d\n        ora a\n        mov m,a\n        jz o_cc_l4\n        inx d\n        inx h\n        jmp o_cc_l3\n    o_cc_l4:\n        push b\n        pop h\n\tRET\n"},mkslice:{uses:["__heap"],code:"\tMOV A,B\n\tORA C\n\tJZ mks_skip\n\tDCX B\n\tDCX D\n\tINX H\n\tJMP mkslice\nmks_skip:\n\tINX D\n\t;maximum\n\tpush h\n\t;lxi b,0\nmks_fix:\n\tmov a,m\n\tora a\n\tjz mks_m\n\tinx h\n\tinx b\n\tdcx d\n\tmov a,d\n\tora e\n\tjnz mks_fix\nmks_m:\n\tpop h\n\tPUSH B\n\tPUSH H\n\tCALL hp_a\n\tPOP D\n\tPOP B\n\tPUSH H\nmks_loop:\n\tMOV A,B\n\tORA C\n\tJZ mks_end0\n\tLDAX D\n\tMOV M,A\n\tORA A\n\tJZ mks_end\n\tDCX B\n\tINX D\n\tINX H\n\tJMP mks_loop\nmks_end0:\n\tMVI M,0\nmks_end:\n\tPOP H\n\tRET\n"},stslice:{uses:["__heap"],code:"\tMOV A,B\n\tORA C\n\tJZ sts_skip\n\tDCX B\n\tDCX D\n\tINX H\n\tJMP stslice\nsts_skip:\n\tINX D\n\tpush h\n\t;lxi b,0\nsts_fix:\n\tmov a,m\n\tora a\n\tjz sts_m\n\tinx h\n\tinx b\n\tdcx d\n\tmov a,d\n\tora e\n\tjnz sts_fix\nsts_m:\n\tpop h\n\tRET\n"},stcpy:{uses:["__heap"],code:"\tMOV A,M\n\tORA A\n\tJZ stcp_d\n\tLDAX D\n\tORA A\n\tJZ stcp_d\n\tMOV M,A\n\tINX H\n\tINX D\n\tDCX B\n\tMOV A,B\n\tORA C\n\tJNZ stcpy\nstcp_d: RET\n"},strclone:{uses:["__heap"],code:"\tLXI B,0\n\tPUSH H\nstrc_len: MOV A,M\n\tORA A\n\tJZ strc_g\n\tINX B\n\tINX H\n\tJMP strc_len\nstrc_g: MOV A,B\n\tORA C\n\tRZ\n\tCALL hp_a\n\tPOP D\n\tPUSH H\nstrc_c: LDAX D\n\tORA A\n\tJZ strc_f\n\tMOV M,A\n\tINX H\n\tINX D\n\tJMP strc_c\nstrc_f: POP H\n\tRET\n"},f_max:{uses:null,code:"\tRET\n"},f_abs:{uses:null,code:"\tMOV A,H\n\tORA A\n\tRP\n\tCMA\n\tMOV H,A\n\tMOV A,L\n\tCMA\n\tMOV L,A\n\tINX H\n\tRET\n"},f_neg:{uses:null,code:"\tMOV A,H\n\tCMA\n\tMOV H,A\n\tMOV A,L\n\tCMA\n\tMOV L,A\n\tINX H\n\tRET\n"},f_sgn:{uses:null,code:"\tMOV A,H\n\tRLCA\n\tJC f_sgn_m\n\tLXI H,1\n\tRET\nf_sgn_m: LXI H,0FFFFh\n\tRET\n"},f_rnd:{uses:null,sysdw:["rndseed"],code:"\tRET\n"},s_getaddr:{uses:null,code:"\tDAD D\t;o_add\n\tMOV E,M\n\tINX H\n\tMOV D,M\n\tXCHG\n\tRET\n"},f_peek:{uses:null,code:"\tMOV A,M\n\tMVI H,0\n\tMOV L,A\n\tRET\n"},f_dpeek:{uses:null,code:"\tMOV A,M\n\tINX H\n\tMOV H,M\n\tMOV L,A\n\tRET\n"},f_len:{uses:[],code:"\tPUSH D\n\tLXI D,0\nf_ll:MOV A,M\n\tORA A\n\tJZ f_le\n\tINX D\n\tINX H\n\tJMP f_ll\nf_le:\tXCHG\n\tPOP D\n\tRET\n"},f_val:{uses:["s_mul10add","f_neg"],code:"\tpush d\n    mvi c,0 ;sign\n    lxi d,0\n    mov a,m\n    cpi 2Dh ;-\n    jnz f_v_c1\n    inx h\n    mvi c,1 ;sign\nf_v_c:    \n    mov a,m\nf_v_c1:    \n    ora a\n    jz f_v_ret\n    cpi 30h ;0\n    jc f_v_ret\n    cpi 3ah\n    jnc f_v_ret\n    push h\n    xchg\n    sui 30h\n    mov e,a\n    mvi d,0\n    call s_mul10add\n    xchg\n    pop h\n    inx h\n    jmp f_v_c\nf_v_ret:\n    xchg\n\tpop d\n    mov a,c\n    ora a\n    rz\n    jmp f_neg\n"},f_low:{uses:null,inline:!0,code:"\tMVI H,0\n"},f_high:{uses:null,inline:!0,code:"\tMOV L,H\n\tMVI H,0\n"},f_chrS:{uses:["__heap"],code:"\tMOV A,L\n\tpush psw\n\tlxi b,2\n\tcall hp_a\n\tpop psw\n\tmov m,a\n\tinx h\n\tmvi m,0\n\tdcx h\n\tRET\n"}};var CONFIG={OMENALPHA:{org:"8000h",ramtop:"0f800h",goback:"RST 0",xp:{_dirty:function(n){return n.indexOf(!1)},_exprAsm:function(n,t,e,r,u,a){var i=t(e,r,u,a);return i.indexOf("[*DD*]")<0?i:i="\tPUSH D\n"+(i=i.replace(";[*DD*]\n",""))+"\tPOP D\n"},num:function(n,t){return"\tLXI H,"+n.value+"\n"},numL:function(n,t){return";[*DD*]\n\tLXI D,"+n.value+"\n"},str:function(n,t,e){return"\tLXI H,cs_"+e+"\t;"+n.value+"\n"},strL:function(n,t){return";[*DD*]\n\tLXI D,"+n.value+"\n"},var:function(n,t){return"\tLHLD v_"+n.value+"\n"},varL:function(n,t){return";[*DD*]\n\tXCHG\n\tLHLD v_"+n.value+"\n\tXCHG\n"},varS:function(n,t){return"\tLHLD vs_"+n.value+"\n"},varSL:function(n,t){return";[*DD*]\n\tXCHG\n\tLHLD vs_"+n.value+"\n\tXCHG\n"},varA:function(n,t,e,r){e.addUse("s_check");var u=";[*DD*]\n"+r(n.index,t,"int");return u+="\tLXI D,vai_"+n.value+"\n",u+="\tLXI B,"+e.intarr[n.value]+"\n",u+="\tCALL s_check\n",u+="\tMOV E,M\n\tINX H\n\tMOV D,M\n\tXCHG\n"},varAI:function(n,t){return n.index.value?"\tLHLD vai_"+n.value+"+"+2*n.index.value+"\n":"\tLHLD vai_"+n.value+"\n"},varAL:function(n,t,e,r){e.addUse("s_check");var u="\tPUSH H\n"+r(n.index,t,"int");return u+="\tLXI D,vai_"+n.value+"\n",u+="\tLXI B,"+e.intarr[n.value]+"\n",u+="\tCALL s_check\n",u+="\tMOV E,M\n\tINX H\n\tMOV D,M\n\tPOP H\n"},varAIL:function(n,t){return n.index.value?";[*DD*]\n\tXCHG\n\tLHLD vai_"+n.value+"+"+2*n.index.value+"\n\tXCHG\n":";[*DD*]\n\tXCHG\n\tLHLD vai_"+n.value+"\n\tXCHG\n"},sliceS:function(n,t,e,r){e.addUse("mkslice");var u="\tPUSH D\n\tPUSH H\n";return u+=r(n.from,t,"int"),u+="\tMOV C,L\n\tMOV B,H\n",u+=r(n.to,t,"int",!0),u+="\tPOP H\n",u+="\tCALL mkslice\n",u+="\tPOP D\n"},sliceSL:function(n,t,e,r){e.addUse("mkslice");var u="\tPUSH H\n";return u+=r(n.from,t,"int"),u+="\tMOV C,L\n\tMOV B,H\n",u+=r(n.to,t,"int",!0),u+="\tPOP H\n",u+="\tCALL mkslice\n",u+="\tXCHG\n"},userfn:function(n,t,e,r,u){var a="\tPUSH D\n";return a+=r(n.operands[1],t,"int"),3==n.operands.length&&(a+=r(n.operands[2],t,"int",!0)),a+="\tCALL CMD"+u+"\n",a+="\tPOP D\n"},userfnL:function(n,t,e,r,u){var a="\tPUSH H\n";return a+=r(n.operands[1],t,"int"),3==n.operands.length&&(a+=r(n.operands[2],t,"int",!0)),a+="\tCALL CMD"+u+"\n",a+="\tPOP D\n\tXCHG\n"},fn:function(n,t,e,r,u){var a="";if(1==n.operands.length)a+=r(n.operands[0]);else if(2==n.operands.length)a+=r(n.operands[0],!0),a+=r(n.operands[1]);else for(var i=0;i<n.operands.length;i++)a+=r(n.operands[i])+"\tPUSH H\n";return e.addUse("f_"+n.value),u["f_"+n.value].inline?a+=u["f_"+n.value].code:a+="\tCALL f_"+n.value+"\n"},fnL:function(n,t,e,r,u){var a=";[*DD*]\n";if(1==n.operands.length)a+=r(n.operands[0]);else if(2==n.operands.length)a+=r(n.operands[0],!0),a+=r(n.operands[1]);else for(var i=0;i<n.operands.length;i++)a+=r(n.operands[i])+"\tPUSH H\n";return e.addUse("f_"+n.value),u["f_"+n.value].inline?(a+=u["f_"+n.value].code)+"\tXCHG\n":a+="\tCALL f_"+n.value+"\n\tXCHG\n"},shortcuts:function(n,t,e,r,u){return"num"==n.right.type&&1==n.right.value&&"+"==n.operator?u(n.left,t,e)+"\tINX H\n":"num"==n.left.type&&1==n.left.value&&"+"==n.operator?u(n.right,t,e)+"\tINX H\n":"num"==n.right.type&&1==n.right.value&&"-"==n.operator?u(n.left,t,e)+"\tDCX H\n":"num"==n.right.type&&2==n.right.value&&"*"==n.operator?u(n.left,t,e)+"\tDAD H\n":"num"==n.right.type&&4==n.right.value&&"*"==n.operator&&u(n.left,t,e)+"\tDAD H\n\tDAD H\n"},binary:function(n,t,e,r,u,a){var i="";i="num"==n.left.type&&"binary"==n.right.type?u(n.right,t,e)+u(n.left,t,e,!0):"num"==n.left.type&&"fn"==n.right.type?u(n.right,t,e)+u(n.left,t,e,!0):(i=u(n.left,t,e,!0)+this._exprAsm(this,u,n.right,t,e)).replace(";[*DD*]\n","");var o="o_"+opAsm(n.operator,t,e);return a[o].inline?i+=a[o].code:(r.addUse(o),i+="\tCALL "+o+"\n")},binaryL:function(n,t,e,r,u,a){return this.binary(n,t,e,r,u,a)+"\tXCHG\n"}},system:{serout:{uses:null,sysdb:["prtchan"],code:"\tPUSH PSW\nso_wait: IN 0deh ;acias\n\tani 2\n\tjz so_wait\n\tpop psw ;aciad\n\tout 0dfh\n\tRET\n"},serin:{uses:["serout"],sysdb:["prtchan","inpchan"],code:"\tIN 0deh ;acias\n\tani 1\n\trz\n\tin 0dfh ;aciad\n\tcall serout\n\tora a\n\tRET\n"}},asm:{jmp:function(n){return"\tJMP "+n+"\n"},jmpNZ:function(n){return"\tJNZ "+n+"\n"},jmpZ:function(n){return"\tJZ "+n+"\n"},jmpEx0:function(n){return"\tMOV A,H\n\tORA L\n\tJZ "+n+"\n"},docall:function(n){return"\tCALL "+n+"\n"},ret:function(){return"\tRET\n"},end:function(){return"\tRST 0\n"},dopush:function(){return"\tPUSH H\n"},dopop:function(){return"\tPOP H\n"},stackSwap:function(){return"\tXTHL\n"},swap:function(){return"\tXCHG\n"},varplus1:function(n){return"\tLHLD v_"+n+"\n\tINX H\n\tSHLD v_"+n+"\n"},varminus1:function(n){return"\tLHLD v_"+n+"\n\tDCX H\n\tSHLD v_"+n+"\n"},varplus2:function(n){return"\tLHLD v_"+n+"\n\tINX H\n\tINX H\n\tSHLD v_"+n+"\n"},varminus2:function(n){return"\tLHLD v_"+n+"\n\tDCX H\n\tDCX H\n\tSHLD v_"+n+"\n"},vartimes2:function(n){return"\tLHLD v_"+n+"\n\tDAD H\n\tSHLD v_"+n+"\n"},storeInt:function(n){return"\tSHLD v_"+n+"\n"},storeStr:function(n){return"\tSHLD vs_"+n+"\n\tCALL hp_assign\n\tcall hp_gc\n"},storeSlice:function(n,t,e,r,u){r.addUse("stslice"),r.addUse("strclone"),r.addUse("stcpy");var a="\tPUSH H\n";return a+="\tLHLD vs_"+n+"\n",a+="\tCALL strclone\n",a+="\tSHLD vs_"+n+"\n\tPUSH H\n\tCALL hp_assign\n\tcall hp_gc\n",a+="",a+=u(t.from,e,"int"),a+="\tMOV C,L\n\tMOV B,H\n",a+=u(t.to,e,"int",!0),a+="\tPOP H\n",a+="\tCALL stslice\n",a+="\tPOP D\n",a+="\tCALL stcpy\n"},storeStrNoGC:function(n){return"\tSHLD vs_"+n+"\n\tCALL hp_assign\n"},storeA:function(n,t,e,r,u){var a="";return r.addUse("s_check"),a+="\tPUSH H\n",a+=u(n.index,t,e),a+="\tLXI D,vai_"+n.value+"\n",a+="\tLXI B,"+r.intarr[n.value]+"\n",a+="\tCALL s_check\n",a+="\tPOP D\n",a+="\tMOV M,E\n",a+="\tINX H\n",a+="\tMOV M,D\n"},storeAI:function(n,t){return t?"\tSHLD vai_"+n+"+"+2*t+"\n":"\tSHLD vai_"+n+"\n"},storeAnyInt:function(n){return"\tSHLD "+n+"\n"},poke:function(n,t,e,r,u,a){var i="";return"num"!=e.type&&(i+=u(e,a,r),i+="\tpush h\n"),i+=u(n,a,t),"num"!=e.type?(i+="\tpop d\n",i+="\tmov m,e\n"):i+="\tmvi m,"+e.value%256+"\n",i},dpoke:function(n,t,e,r,u,a){var i="";return"num"==n.type?(i+=u(e,a,r),i+="\tSHLD "+n.value+"\n"):("num"!=e.type&&(i+=u(e,a,r),i+="\tpush h\n"),i+=u(n,a,t),"num"!=e.type?(i+="\tpop d\n",i+="\tmov m,e\n",i+="\tinx h\n",i+="\tmov m,d\n"):(i+="\tmvi m,"+e.value%256+"\n",i+="\tinx h\n",i+="\tmvi m,"+(e.value>>8)+"\n"),i)},_forstep:function(n){var t="",e=n[0][4];return"ex"==e?(t+="\tXCHG\n",t+="\tLHLD sv_forS"+n[0][2]+"\n",t+="\tDAD D\n"):1==e?t+="\tINX H\n":(t+="\tLXI D,"+e+"\n",t+="\tDAD D\n"),t},_fortest:function(n){var t="",e=n[0][5];return"ex"==e?(t+="\tXCHG\n",t+="\tLHLD sv_forL"+n[0][2]+"\n"):t+="\tLXI D,"+e+"\n",t+="\tMOV A,L\n",t+="\tCMP E\n",t+="\tJNZ FLCMD"+n[0][2]+"\n",t+="\tMOV A,H\n",t+="\tCMP D\n",t+="\tJNZ FLCMD"+n[0][2]+"\n"},strUnassign:function(n){return"\tLHLD vs_"+n+"\n\tCALL hp_unass\n"}}}};function InputStream(n){var t=0,r=1,u=0;return{next:function(){var e=n.charAt(t++);"\n"==e?(r++,u=0):u++;return e},peek:e,eof:function(){return""==e()},croak:function(e){throw new Error(e+" ("+r+":"+u+")")}};function e(){return n.charAt(t)}}function TokenStream(u){var n=null,t=" if then else rem print input goto let for to next step gosub return end stop data read restore repeat until continue break poke dpoke dim ramtop push pop take def call swap while endwhile ",r=" abs neg rnd max chr$ sgn len val peek dpeek low high fn ";return{next:function(){var e=n;return n=null,e||v()},peek:e,eof:function(){return null==e()},croak:u.croak};function o(e){return 0<=r.indexOf(" "+e.toLowerCase()+" ")}function a(e){return/[0-9]/i.test(e)}function l(e){return/[a-z_]/i.test(e)}function f(e){return l(e)||0<="?!0123456789".indexOf(e)}function i(e){return 0<="+-*/%=&|<>!".indexOf(e)}function s(e){return 0<=" \t\n\r".indexOf(e)}function p(e){for(var n="";!u.eof()&&e(u.peek());)n+=u.next();return n}function k(){var e,n=p(f);return"$"==u.peek()?(u.next(),o(n+"$")?{type:"fn",value:n.toLowerCase()+"S"}:{type:"var$",value:n.toLowerCase()}):{type:(e=n,0<=t.indexOf(" "+e.toLowerCase()+" ")?"kw":o(n)?"fn":"var"),value:n.toLowerCase()}}function c(){return{type:"str",value:function(e){var n=!1,t="";for(u.next();!u.eof();){var r=u.next();if(n)t+=r,n=!1;else if("\\"==r)n=!0;else{if(r==e)break;t+=r}}return t}('"')}}function v(){if(p(s),u.eof())return null;var n,e,t=u.peek();if('"'==t)return c();if("$"==t)return function(){u.next();var e=p(function(e){return/[0-9a-fA-F]/i.test(e)});return{type:"num",value:parseInt(e,16)}}();if(a(t))return n=!1,e=p(function(e){return"."==e?!n&&(n=!0):a(e)}),{type:"num",value:parseFloat(e)};if(l(t)){var r=k();return"kw"==r.type&&"rem"==r.value?{type:"remark",value:p(function(e){return"\n"!=e})}:r}return 0<=":".indexOf(t)?{type:"colon",value:u.next()}:0<=",;#(){}[]".indexOf(t)?{type:"punc",value:u.next()}:i(t)?{type:"op",value:p(i)}:void u.croak("Can't handle character: "+t)}function e(){return n||(n=v())}}function parse(e){for(var n=e.split("\n"),t=[],r=0;r<n.length;r++){for(var u=n[r],o={source:u,rawTokens:[],label:null,_numline:r,_cmd:1},a=TokenStream(InputStream(u));!a.eof();){var l=a.next();o.rawTokens.push(l)}if(o.rawTokens.length&&(o.tokens=[].concat(o.rawTokens),("num"!=o.tokens[0].type||(o.label=o.tokens.shift().value,o.tokens.length))&&(!("var"==o.tokens[0].type&&1<o.tokens.length&&"colon"==o.tokens[1].type&&":"==o.tokens[1].value)||(o.label=o.tokens.shift().value,o.tokens.shift(),o.tokens.length)))){for(var f=[];o.tokens.length;){"colon"==(l=o.tokens.shift()).type||"kw"==l.type&&"then"==l.value?("var"==f[0].type&&f.unshift({type:"kw",value:"let"}),"var$"==f[0].type&&f.unshift({type:"kw",value:"let"}),"kw"==l.type&&"then"==l.value&&(f.push(l),o.tokens.length&&"num"==o.tokens[0].type&&f.push({type:"kw",value:"goto"})),t.push({source:u,rawTokens:o.rawTokens,label:o.label,_numline:o._numline,_cmd:o._cmd,tokens:f}),f=[],o.label=null,o._cmd++,"kw"==l.type&&"then"==l.value&&o.tokens.length&&"num"==o.tokens[0].type&&f.push({type:"kw",value:"goto"})):f.push(l)}"var"==f[0].type&&f.unshift({type:"kw",value:"let"}),"var$"==f[0].type&&f.unshift({type:"kw",value:"let"}),o.tokens=f,t.push(o)}}return t}var PRECEDENCE={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"<>":7,"+":10,"-":10,"*":20,"/":20,"%":20},ARITY={max:["int","int"],abs:["int"],neg:["int"],low:["int"],high:["int"],peek:["int"],fn:["int","int"],dpeek:["int"],sgn:["int"],rnd:[],len:["str"],val:["str"],chrS:["int"]},exprType=function(e,t){var r="undefined";if("num"==(r=e.type))return"int";if("str"==r)return"str";if("var"==r)return"int";if("var[]"==r)return"int";if("var$"==r)return"str";if("slice$"==r)return"str";if("binary"==r){var n=exprType(e.left,t);if(n==exprType(e.right,t))return n;croak("Mismatched types in expression",t)}if("fn"==r){var u=e.value;return"S"==u[u.length-1]?"str":"int"}croak("Invalid expression type",t)},compute=function(e,t,r){switch(r){case"+":return e+t;case"-":return e-t;case"*":return e*t;case"/":return e/t}},expr=function(p,v,l){var s=function(e){var t=p.shift();t||croak(e+" is missing",v),"punc"!=t.type&&croak(e+" is missing, "+t.type+"instead",v),t.value!=e&&croak(e+" is missing, "+t.value+" instead",v)},i=function(){var e=p.shift();if("op"==e.type&&"-"==e.value)return(e=p.shift()).value=-1*e.value,e;if("var"==e.type&&p.length&&"punc"==p[0].type&&"("==p[0].value){if(ENV.fns[e.value]==e.value){var t=[{type:"var",value:e.value}];s("(");var r=expr(p,v,l);return t.push(r),"punc"==p[0].type&&","==p[0].value&&(s(","),r=expr(p,v,l),t.push(r)),s(")"),{type:"fn",value:"fn",operands:t}}s("(");r=expr(p,v,l);var n=exprType(r,v);return s(")"),{type:"var[]",value:e.value,index:r}}if("var$"==e.type&&p.length&&"punc"==p[0].type&&"("==p[0].value){if(s("("),"kw"==p[0].type&&"to"==p[0].value){p.shift();r={type:"num",value:0};if("punc"==p[0].type&&")"==p[0].value)var u={type:"num",value:32767};else u=expr(p,v,l)}else{r=expr(p,v,l);if(p.length&&"kw"==p[0].type&&"to"==p[0].value)if(p.shift(),"punc"==p[0].type&&")"==p[0].value)u={type:"num",value:32767};else u=expr(p,v,l)}return s(")"),{type:"slice$",value:e.value,from:r,to:u}}if("fn"==e.type){var a=ARITY[e.value].length;t=[];s("(");for(;0<a;){r=expr(p,v,l),n=exprType(r,v);if(ARITY[e.value][0]!=n&&croak("Argument type mismatch, given:"+n+", expected: "+ARITY[e.value][0],v),t.push(r),"fn"==e.value){if("punc"==p[0].type&&")"==p[0].value)break;"punc"==p[0].type&&","==p[0].value&&a++}--a&&s(",")}return s(")"),{type:"fn",value:e.value,operands:t}}if("punc"==e.type&&"("==e.value){var i=expr(p,v,l);return s(")"),i}return e},f=function(e,t){if(!p.length)return e;var r=p[0];if("op"!=r.type)return e;var n=PRECEDENCE[r.value];if(t<n){p.shift();var u=f(i(),n),a={type:"="!=r.value||l?"binary":"assign",operator:r.value,left:e,right:u};return"num"==e.type&&"num"==u.type&&(a={type:"num",value:compute(e.value,u.value,r.value)}),"str"==e.type&&"str"==u.type&&"+"==r.value&&(a={type:"str",value:e.value+u.value}),f(a,t)}return e};return f(i(),0)};var labelIndex=function(a){for(var e={},n=0;n<a.length;n++){if(a[n].label)e[a[n].label]=n}return e},findNewLine=function(a,e){for(var n=e[a]._numline;a<e.length;)if(e[++a]._numline>n)return a;return null},skipMark=function(a,e){var n=findNewLine(a,e);n&&(e[n]._skip||(e[n]._skip=[]),e[n]._skip.push(a))},findLabel=function(a,e){return void 0!==e[a]?e[a]:null},croak=function(a,e){throw new Error(a+" ("+e._numline+":"+e._cmd+")")},opAsm=function(a,e,n){if("str"==n){switch(a){case"+":return"concat";case"=":return"streq"}croak("Invalid string operator",e)}switch(a){case"+":return"add";case"-":return"sub";case"*":return"mul";case"/":return"div";case"%":return"mod";case"=":return"eq";case"<>":return"neq";case"<":return"lt";case">":return"gt";case"<=":return"le";case">=":return"ge"}},varAsm=function(){var a="";for(var e in ENV.vars){var n=ENV.vars[e],r=e.split("_")[0];switch(n){case"int":a+="v_"+r+":\t DS 2\n";continue;case"str":a+="vs_"+r+":\t DS 2\n";continue;case"sysdb":a+="sv_"+r+":\t DS 1\n";continue;case"sysdw":a+="sv_"+r+":\t DS 2\n";continue}}for(var e in ENV.intarr){a+="vai_"+e+":\t DS "+2*ENV.intarr[e]+"\n"}return a},strAsm=function(){for(var a="",e=0;e<ENV.strs.length;e++){a+="cs_"+e+':\t DB "'+ENV.strs[e]+'",0\n'}return a},fnAsm=function(){for(var a,e="";a=ENV.uses.shift();){var n=LIB[a];if(!n)throw new Error("Cannot link "+a);if(n.sysdb)for(var r=0;r<n.sysdb.length;r++)ENV.addVar(n.sysdb[r],"sysdb");if(n.sysdw)for(r=0;r<n.sysdw.length;r++)ENV.addVar(n.sysdw[r],"sysdw");e+=";---"+a+"---\n",e+=a+":\n",e+=n.code,e+=";---"+a+"-end---\n\n"}return e},ENV={vars:{},addVar:function(a,e){ENV.vars[a+"_"+e]=e},fns:{},addFn:function(a){a=a.toLowerCase(),ENV.fns[a]=a},procs:{},addProc:function(a){a=a.toLowerCase(),ENV.procs[a]=a},intarr:{},addArrInt:function(a,e){ENV.intarr[a]=e},strs:[],addStr:function(a){return ENV.strs.indexOf(a)<0&&ENV.strs.push(a),ENV.strs.indexOf(a)},datas:[],datalabels:[],addData:function(a,e){e&&(ENV.datas.push("dt_"+e+":\n"),ENV.datalabels.push(e)),ENV.datas.push("\t DW "+a+"\n")},uses:[],addUse:function(a){if(ENV.uses.indexOf(a)<0){ENV.uses.push(a);var e=LIB[a];if(!e)throw new Error("Cannot link "+a);if(e.uses)for(var n=0;n<e.uses.length;n++){var r=e.uses[n];ENV.addUse(r)}}return ENV.uses.indexOf(a)}},generator=function(a,l){for(var e in ENV.vars={},ENV.strs=[],ENV.uses=[],ENV.fns={},ENV.procs={},ENV.datas=[],ENV.datalabels=[],l.system)LIB[e]=l.system[e];var d=function(a,e,n,r){void 0===n&&(n="int"),void 0===r&&(r=!1);var t=a.type;if("num"==t&&!r)return l.xp.num(a,e);if("str"==t&&!r){var s=ENV.addStr(a.value);return l.xp.str(a,e,s)}if("num"==t&&r)return l.xp.numL(a,e);if("str"==t&&r){s=ENV.addStr(a.value);return l.xp.strL(a,e,s)}if("var"==t&&!r)return ENV.addVar(a.value,"int"),l.xp.var(a,e);if("var"==t&&r)return ENV.addVar(a.value,"int"),l.xp.varL(a,e);if("var$"==t&&!r)return ENV.addVar(a.value,"str"),l.xp.varS(a,e);if("slice$"==t&&!r)return ENV.addVar(a.value,"str"),l.xp.varS(a,e)+l.xp.sliceS(a,e,ENV,d);if("slice$"==t&&r)return ENV.addVar(a.value,"str"),l.xp.varS(a,e)+l.xp.sliceSL(a,e,ENV,d);if("var$"==t&&r)return ENV.addVar(a.value,"str"),l.xp.varSL(a,e);if("var[]"==t&&(ENV.intarr[a.value]||croak("You have to DIM array first",e),"num"==a.index.type&&a.index.value>=ENV.intarr[a.value]&&croak("Index out of bound",e)),"var[]"==t&&!r)return"num"==a.index.type?l.xp.varAI(a,e):l.xp.varA(a,e,ENV,d);if("var[]"==t&&r)return"num"==a.index.type?l.xp.varAIL(a,e):l.xp.varAL(a,e,ENV,d);if("binary"==t){var i=l.xp.shortcuts(a,e,n,ENV,d);return i||(r?l.xp.binaryL(a,e,n,ENV,d,LIB):l.xp.binary(a,e,n,ENV,d,LIB))}if("fn"==t&&!r){if("fn"==a.value){var o=a.operands[0];return null===(u=findLabel(o.value,ENV.labels))&&croak("Target line not found",e),l.xp.userfn(a,e,ENV,d,u)}return l.xp.fn(a,e,ENV,d,LIB)}if("fn"==t&&r){if("fn"==a.value){var u;o=a.operands[0];return null===(u=findLabel(o.value,ENV.labels))&&croak("Target line not found",e),l.xp.userfnL(a,e,ENV,d,u)}return l.xp.fnL(a,e,ENV,d,LIB)}croak("Cannot evaluate "+JSON.stringify(a),e)},n=function(a){return!!v.length&&("punc"==v[0].type&&(v[0].value==a&&(v.shift(),!0)))},r=function(a){return!!v.length&&("op"==v[0].type&&(v[0].value==a&&(v.shift(),!0)))},t=function(){return!!v.length&&("var"==v[0].type&&v.shift())},s="";s+=";----CODE SEGMENT (ROMable)\n";var i=labelIndex(a);ENV.labels=i;for(var o=[],u=0;u<a.length;u++){var c,p=a[u];s+="CMD"+u+":\n",p._skip&&(s+="SKIP"+p._skip[0]+":\n");var v=[].concat(p.tokens);if("kw"==v[0].type){var f=v[0].value;switch(v.shift(),s+="; "+f+"\n",f){case"goto":_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),s+=l.asm.jmp("CMD"+k);continue;case"gosub":_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),s+=l.asm.docall("CMD"+k);continue;case"return":if(v.length){var m=expr(v,p),E=exprType(m,p);if(s+=d(m,p,E),n(";")){for(s+=l.asm.swap();v.length;){(m=t())||croak("POP needs a variable name",p),ENV.addVar(m.value,"int"),s+=l.asm.dopop(),s+=l.asm.storeInt(m.value,p),v.length&&(n(",")||croak("Separate names with a comma",p))}s+=l.asm.swap()}}s+=l.asm.ret();continue;case"end":s+=l.asm.end();continue;case"stop":ENV.addUse("errstop"),s+=l.asm.jmp("ERRSTOP");continue;case"repeat":o.unshift(["CMD"+u,"R"]);continue;case"endwhile":o.length||croak("ENDWHILE without WHILE",p),"W"!=o[0][1]&&croak("WHILE / ENDWHILE mismatched",p),s+=l.asm.jmp(o[0][0]),s+="WB"+o[0][0]+":\n",o.shift();continue;case"break":o.length||croak("BREAK outside the loop",p),s+=l.asm.jmp(o[0][1]+"B"+o[0][0]);continue;case"continue":o.length||croak("CONTINUE outside the loop",p),s+=l.asm.jmp(o[0][1]+"C"+o[0][0]);continue;case"dim":"var[]"!=(y=expr(v,p)).type&&croak("DIM needs a variable name",p),"num"!=y.index.type&&croak("DIM needs a constant size",p),ENV.addArrInt(y.value,y.index.value);continue;case"data":for(var V=p.label;_=v.shift();){if("num"==_.type){if(ENV.addData(_.value,V),!n(","))break}else if("str"==_.type){if(ENV.addData("cs_"+ENV.addStr(_.value),V),!n(","))break}else croak("Invalid data",p);V=null}continue;case"restore":if(v.length){ENV.addUse("s_lut"),ENV.addUse("errnodata");m=expr(v,p),E=exprType(m,p);s+=d(m,p,E),s+=l.asm.docall("s_lut"),s+=l.asm.jmpZ("errnodata"),s+=l.asm.storeAnyInt("datapoint");continue}s+=l.xp.num({value:"databegin"},p),s+=l.asm.storeAnyInt("datapoint");continue;case"read":for(ENV.addUse("s_read");v.length;){(m=!!v.length&&("var"==v[0].type||"var$"==v[0].type)&&v.shift())||croak("READ needs a variable name",p),"var"==m.type?(ENV.addVar(m.value,"int"),s+=l.asm.docall("s_read"),s+=l.asm.storeInt(m.value,p)):(ENV.addUse("__heap"),ENV.addVar(m.value,"int"),s+=l.asm.strUnassign(m.value),s+=l.asm.docall("s_read"),s+=l.asm.storeStr(m.value,p)),v.length&&(n(",")||croak("Separate names with a comma",p))}continue;case"def":if("fn"==(_=v[0]).type&&"fn"==_.value){v.shift(),_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),ENV.addFn(_.value);continue}if("var"==_.type&&"proc"==_.value){v.shift(),_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),ENV.addProc(_.value);continue}croak("DEF without FN",p);continue;case"ramtop":"num"!=(_=v[0]).type&&croak("RAMTOP needs a constant value",p),l.ramtop=_.value;continue;case"swap":if((m=t())||croak("SWAP needs a variable name",p),s+=l.xp.var(m,p),ENV.addVar(m.value,"int"),!v.length)continue;n(",")||croak("Separate names with a comma",p),(x=t())||croak("SWAP needs two variables",p),ENV.addVar(x.value,"int"),s+=l.asm.swap(),s+=l.xp.var(x,p),s+=l.asm.storeInt(m.value),s+=l.asm.swap(),s+=l.asm.storeInt(x.value);continue;case"push":for(;v.length;){(m=t())||croak("PUSH needs a variable name",p),s+=l.xp.var(m,p),ENV.addVar(m.value,"int"),s+=l.asm.dopush(),v.length&&(n(",")||croak("Separate names with a comma",p))}continue;case"pop":for(;v.length;){(m=t())||croak("POP needs a variable name",p),ENV.addVar(m.value,"int"),s+=l.asm.dopop(),s+=l.asm.storeInt(m.value,p),v.length&&(n(",")||croak("Separate names with a comma",p))}continue;case"take":if((m=t())||croak("TAKE needs a variable name",p),ENV.addVar(m.value,"int"),!v.length){s+=l.asm.storeInt(m.value,p);continue}if(n(";")){for(;v.length;){s+=l.asm.dopush(),(h=t())||croak("TAKE PUSH needs a variable name",p),ENV.addVar(h.value,"int"),s+=l.xp.var(h,p),s+=l.asm.stackSwap(),v.length&&(n(",")||croak("Separate names with a comma",p))}s+=l.asm.storeInt(m.value,p);continue}var N=l.asm.storeInt(m.value,p)+l.asm.swap();if(n(",")||croak("Separate names with a comma",p),(m=t())||croak("Second TAKE needs a variable name",p),ENV.addVar(m.value,"int"),!v.length){s+=N+l.asm.storeInt(m.value,p);continue}if(n(";")){for(;v.length;){var h;s+=l.asm.dopush(),(h=t())||croak("TAKE PUSH needs a variable name",p),ENV.addVar(h.value,"int"),s+=l.xp.var(h,p),s+=l.asm.stackSwap(),v.length&&(n(",")||croak("Separate names with a comma",p))}s+=N+l.asm.storeInt(m.value,p);continue}if(s+=N+l.asm.storeInt(m.value,p),!v.length)continue;croak("TAKE has 2 parameters max",p);continue;case"call":_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),v.shift(),n(",")||croak("Syntax error",p);m=expr(v,p),E=exprType(m,p);if(s+=d(m,p,E),n(",")){var x=expr(v,p);E=exprType(x,p);s+=d(x,p,b,!0)}s+=l.asm.docall("CMD"+k);continue;case"let":if("var"==v[0].type&&ENV.procs[v[0].value]==v[0].value){var k;_=v[0],null===(k=findLabel(_.value,i))&&croak("Target line not found",p),v.shift();m=expr(v,p),E=exprType(m,p);if(s+=d(m,p,E),n(",")){x=expr(v,p),E=exprType(x,p);s+=d(x,p,b,!0)}s+=l.asm.docall("CMD"+k);continue}var y,g=[];if("var"==(y=expr(v,p)).type){if(v.length||croak("LET should assign something",p),r("++")){ENV.addVar(y.value,"int"),s+=l.asm.varplus1(y.value),v.shift();continue}if(r("--")){ENV.addVar(y.value,"int"),s+=l.asm.varminus1(y.value),v.shift();continue}if(r("**")){ENV.addVar(y.value,"int"),s+=l.asm.vartimes2(y.value),v.shift();continue}if(r("+++")){ENV.addVar(y.value,"int"),s+=l.asm.varplus2(y.value),v.shift();continue}if(r("---")){ENV.addVar(y.value,"int"),s+=l.asm.varminus2(y.value),v.shift();continue}if("punc"==v[0].type&&","==v[0].value)for(;n(",");)"var"!=y.type&&croak("Multiassigning needs a scalar int",p),g.push(y),y=expr(v,p);else croak("LET syntax mismatch",p)}"assign"!==y.type&&croak("LET should assign",p),"var"!=(_=y.left).type&&"var[]"!=_.type&&"var$"!=_.type&&"slice$"!=_.type&&croak("No variable name",p),"var$"==_.type&&(ENV.addVar(_.value,"str"),ENV.addUse("__heap"),s+=l.asm.strUnassign(_.value)),"slice$"==_.type&&(ENV.addVar(_.value,"str"),ENV.addUse("__heap"),s+=l.asm.strUnassign(_.value));m=y.right,E=exprType(m,p);if(s+=d(m,p,E),"var"==_.type)for("int"!=E&&croak("Cannot assign this to int variable",p),ENV.addVar(_.value,"int"),s+=l.asm.storeInt(_.value);g.length;)_=g.pop(),s+=l.asm.storeInt(_.value);else"var[]"==_.type?("int"!=E&&croak("Cannot assign this to int variable",p),ENV.intarr[_.value]||croak("You have to DIM array first",p),"num"==_.index.type&&_.index.value>=ENV.intarr[_.value]&&croak("Index out of bound",p),"num"==_.index.type?s+=l.asm.storeAI(_.value,_.index.value):s+=l.asm.storeA(_,p,E,ENV,d)):"var$"==_.type?("str"!=E&&croak("Cannot assign this to string variable",p),s+=l.asm.storeStr(_.value)):"slice$"==_.type&&("str"!=E&&croak("Cannot assign this to string slice",p),s+=l.asm.storeSlice(_.value,_,p,ENV,d));continue;case"poke":m=expr(v,p),E=exprType(m,p);n(",")||croak("Syntax error",p);x=expr(v,p);var b=exprType(x,p);s+=l.asm.poke(m,E,x,b,d,p);continue;case"dpoke":m=expr(v,p),E=exprType(m,p);n(",")||croak("Syntax error",p);x=expr(v,p),b=exprType(x,p);s+=l.asm.dpoke(m,E,x,b,d,p);continue;case"for":"var"!=(_=v.shift()).type&&croak("No usable variable name",p),"op"==(c=v.shift()).type&&"="==c.value||croak("FOR without an initial assignment",p);var I=expr(v,p),S=exprType(I,p);"kw"==(c=v.shift()).type&&"to"==c.value||croak("FOR without TO",p);var T="ex";m=expr(v,p),E=exprType(m,p);"num"==m.type?T=m.value:(s+=d(m,p,E),s+=l.asm.storeAnyInt("sv_forL"+u),ENV.addVar("forL"+u,"sysdw"));var w=1;if(v.length){"kw"==(c=v.shift()).type&&"step"==c.value||croak("Did you mean STEP?",p);m=expr(v,p),E=exprType(m,p);"num"==m.type?w=m.value:(s+=d(m,p,E),s+=l.asm.storeAnyInt("sv_forS"+u),ENV.addVar("forS"+u,"sysdw"),w="ex")}s+=d(I,p,S),ENV.addVar(_.value,"int"),s+=l.asm.storeInt(_.value),s+=l.asm.jmp("FTCMD"+u),s+="FLCMD"+u+":\n",o.unshift(["CMD"+u,"F",u,_.value,w,T]);continue;case"next":o.length||croak("NEXT without FOR",p),"F"!=o[0][1]&&croak("Loops mismatched",p),"var"!=(_=v.shift()).type&&croak("No usable variable name",p),_.value!=o[0][3]&&croak("FOR / NEXT variable mismatch",p),s+="FC"+o[0][0]+":\n",s+=l.xp.var(_.value),s+=l.asm._forstep(o),s+=l.asm.storeInt(_.value),s+="FT"+o[0][0]+":\n",s+=l.asm._fortest(o),s+="FB"+o[0][0]+":\n",o.shift();continue;case"if":m=expr(v,p,!0),E=exprType(m,p);skipMark(u,a),s+=d(m,p,E),s+=l.asm.jmpEx0("SKIP"+u);continue;case"until":o.length||croak("UNTIL without REPEAT",p),"R"!=o[0][1]&&croak("UNTIL / REPEAT mismatched",p);m=expr(v,p,!0);s+="RC"+o[0][0]+":\n",s+=d(m,p),s+=l.asm.jmpEx0(o[0][0]),s+="RB"+o[0][0]+":\n",o.shift();continue;case"while":o.unshift(["CMD"+u,"W"]);m=expr(v,p,!0);s+="WC"+o[0][0]+":\n",s+=d(m,p),s+=l.asm.jmpEx0("WB"+o[0][0]);continue;case"input":for(var L=!1;v.length;)if(n("#")){var A=expr(v,p,!0);s+=d(A,p,"int"),ENV.addUse("inpchan"),s+=l.asm.docall("inpchan"),n(",")||croak("Syntax error",p)}else{var _;if("var"!=(_=expr(v,p)).type)if("var[]"!=_.type)if("var$"!=_.type){m=_,E=exprType(m,p);s+=d(m,p,E),ENV.addUse("print"+E),s+=l.asm.docall("print"+E),D=!0,n(";")?D=!1:n(",")&&(ENV.addUse("printtab"),s+=l.asm.docall("printtab"),D=!1)}else{if(ENV.addVar(_.value,"str"),s+=l.asm.strUnassign(_.value),ENV.addUse("inputstr"),s+=l.asm.docall("inputstr"),ENV.addUse("__heap"),L=!0,s+=l.asm.storeStrNoGC(_.value),!v.length)break;n(",")||croak("Syntax error",p),v.shift()}else{if(ENV.intarr[_.value]||croak("You have to DIM array first",p),"num"==_.index.type&&_.index.value>=ENV.intarr[_.value]&&croak("Index out of bound",p),ENV.addUse("inputint"),s+=l.asm.docall("inputint"),"num"==_.index.type?s+=l.asm.storeAI(_.value,_.index.value):s+=l.asm.storeA(_,p,E,ENV,d),!v.length)break;n(",")||croak("Syntax error",p)}else{if(ENV.addUse("inputint"),ENV.addVar(_.value,"int"),s+=l.asm.docall("inputint"),s+=l.asm.storeInt(_.value),!v.length)break;n(",")||croak("Syntax error",p)}}L&&(s+=l.asm.docall("hp_gc"));continue;case"print":var D=!0;for(L=!1;v.length;)if(n("#")){A=expr(v,p,!0);s+=d(A,p,"int"),ENV.addUse("prtchan"),s+=l.asm.docall("prtchan"),s+="\tCALL prtchan\n",n(",")||croak("Syntax error",p)}else{m=expr(v,p),E=exprType(m,p);s+=d(m,p,E),ENV.addUse("print"+E),s+=l.asm.docall("print"+E),"str"==E&&(L=!0),D=!0,n(";")?D=!1:n(",")&&(ENV.addUse("printtab"),s+=l.asm.docall("printtab"),D=!1)}D&&(ENV.addUse("println"),s+=l.asm.docall("println")),L&&(s+=l.asm.docall("hp_gc"));continue}v.length&&croak("Extra characters",p)}}o.length&&croak("Non-closed loops",p);var U=!1;if(0<=ENV.uses.indexOf("inputint")&&(U=!0),0<=ENV.uses.indexOf("inputstr")&&(U=!0),0<=ENV.uses.indexOf("__heap")&&(s="\tCALL HP_INIT\n"+s),s="\tORG "+l.org+"\n\t.ent $\n\n"+s,s+="ERRGO:\t"+l.goback+"\n",s+=fnAsm(),s+=";----DATA SEGMENT (ROM)\n",s+=strAsm(),s+=";----INITIALIZED DATA SEGMENT (RAM)\n",ENV.datas.length){s+="datapoint: dw $+2\n",s+="databegin:\n",s+=ENV.datas.join(""),s+="datatable: dw 0\n",ENV.datalabels=ENV.datalabels.sort(function(a,e){return e-a});for(u=0;u<ENV.datalabels.length;u++){var C=ENV.datalabels[u];s+="\tdw "+C+",dt_"+C+"\n"}s+="\tdw 0\n"}return s+=";----BSS SEGMENT\n",s+=varAsm(),U&&(s+="i_buffer: ds 257\n"),s+="\n\nHEAP EQU $\nRAMTOP EQU "+l.ramtop+"\nds RAMTOP-$\n\n"};



	return {
		compile: function(source) {
			return generator(parse(source),CONFIG.OMENALPHA)
		}
	}
}));
